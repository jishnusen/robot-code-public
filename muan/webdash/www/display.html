<!DOCTYPE html>

<html>
  <head>
    <link href="/display.css" type="text/css" rel="stylesheet"/>
  </head>
  <body>
	</body>
  <script>
    var displaysock = new WebSocket("ws://" + document.location.host + "/display");
    var datasock = new WebSocket("ws://" + document.location.host + "/data");
    // Used for information required in UpdateDisplay from displaysock
    var display_carryover = {};
    
    // Two functions used due to separate sockets
    displaysock.onmessage = function(data) {
      var display = JSON.parse(data.data);
      MakeDisplay(display);
    }
    datasock.onmessage = function(data) {
      var data = JSON.parse(data.data);
      UpdateDisplay(data);
    }
    
    // Creates framework for display, makes boxes based on number of widgets, equal portions of screen alloted to each widget
    function MakeDisplay(display) {
      display_carryover = display;
      var num_boxes = display["settings"]["size"][0] * display["settings"]["size"][1];
      var box_width = window.innerWidth / display.settings.size[0];
      var box_height = window.innerHeight / display.settings.size[1];
      var widget_name = "";
      // Coords used to determine specific position of widgets
      var coords = "";
      var top_shift = 0;
      var left_shift = 0;

      for (widget of display["widgets"]) {
        left_shift = box_width * widget["coordinates"][0];
        top_shift = box_height * widget["coordinates"][1];
        coords = (widget["coordinates"][0]).toString() + "_" + (widget["coordinates"][1]).toString();  
        document.body.innerHTML += "<div id=" + coords + " style=position:absolute;top:" + top_shift + "px;left:" + left_shift + "px;width:" + box_width + "px;height:" + box_height + "px></div>";
        widget_name = widget["name"];
        if (widget["should-title"] == true) {
          document.getElementById(coords).innerHTML = "<p>" + widget_name + ":</p>";
        }
      }

      alertData();
    }

    // Starts UpdateDisplay function
    function alertData() {
      if (datasock.readyState == 0) {
        window.setTimeout(alertData, 100);
      } else {
        datasock.send("ping")
      }
    }

    // Adds widgets to divs in display based on coordinates and type, aesthetic based on JSON and done through
    function UpdateDisplay(data) {
      var bool_box = "";
      var color = "";
      var coords = "";
      var enum_box = "";
      var number_width = 0;
      var number_percentage = "";
      var bar_id = "";
      var box_id = "";
      var enumerator_id = "";
      for (widget of display_carryover["widgets"]) {
        coords = (widget["coordinates"][0]).toString() + "_" + (widget["coordinates"][1]).toString();
        var source = null;
        if (widget["type"] != "image") {
          var source = data[widget["source"][0]][widget["source"][1]];
        }

        // Creates boolean widgets, colored box
        if (widget["type"] == "boolean") {
          box_id = "box" + coords;
          // Uses hex values from JSON script
          if (source) {
            color = widget["colors"]["if_true"];
          } else {
            color = widget["colors"]["if_false"];
          }
          if (!document.getElementById(box_id)) {
            bool_box = "<div class=\"box\" id=\"" + box_id + "\"></div>";
            document.getElementById(coords).innerHTML += bool_box;
          }
          var background_color = "background-color:" + color;
          document.getElementById(box_id).setAttribute("style", background_color);
        }

        // Creates enum widgets, colored box
        if (widget["type"] == "enum") {
          for (widget_name of widget["names"]) {
            enumerator_id = "enum" + coords;
            // Yet again, hex values gotten from JSON script, but now with n different colors
            if (widget_name == source) {
              color = widget["colors"][widget_name];
            }
            var enum_background_color = "background-color:" + color;
            if (!document.getElementById(enumerator_id)) {
              enum_box = "<div class=\"box\" id=\"" + enumerator_id + "\"></div>";
              document.getElementById(coords).innerHTML += enum_box;
            }
          }
          document.getElementById(enumerator_id).setAttribute("style", enum_background_color);

        }
        
        // Creates number widgets, sliding bar
        if (widget["type"] == "number") {
          bar_id = "full_bar" + coords;
          // Automatic color for consistency
          color = "#000000"
          // Checks value of number and compares to a maximum, minimum, and goal, as decided in the JSON script
          if (source == widget["goal"]) {
            color = widget["colors"]["goal"];
          }
          else if (source < widget["goal"] && source >= widget["min"]) {
            color = widget["colors"]["min"];
          }
          else if (source > widget["goal"] && source <= widget["max"]) {
            color = widget["colors"]["max"];
          }
          if (!document.getElementById(bar_id)) { 
            document.getElementById(coords).innerHTML += "<div id=" + bar_id + " style=border:solid;height:10px;position:relative></div>";
          }
          // If value is too high, just fills the bar
          if (number_width > widget["max"]) {
            number_width = 1;
          } else if (number_width < widget["min"]) {
            number_width = 0;
          } else {
            number_width = (source + widget["min"]) / (widget["max"] - widget["min"]);
          }
          // As the colored bar is surrounded by min to max outline, this decides the percentage of the outline taken up by the bar
          number_percentage = (number_width * 100).toString() + "%";
          document.getElementById(bar_id).innerHTML = "<div style=width:" + number_percentage + 
                                                      ";background-color:" + color + 
                                                      ";position:absolute;height:100%;float:right;text-align:right;opacity:.7;left:0px></div>";
        }

        if (widget["type"] == "image") {
          image_id = "image" + coords;
          if (!document.getElementById(image_id)) { 
            document.getElementById(coords).innerHTML += "<div id=" + image_id + "></div>";
          }
          document.getElementById(image_id).innerHTML = "<img src=\"http://" + document.location.hostname + ":5802/" + widget["source"] + ".mjpeg\"" +
                                                        "alt=\"Unable to read stream\">";
        }
      }
    }
    displaysock.onopen = function() {
      displaysock.send("ping");
    }

   function ReadData() {
     datasock.send("ping");
   }

   // Updates data every 100 milliseconds
   var intervalID = setInterval(ReadData, 100); 
  </script>
</html>
