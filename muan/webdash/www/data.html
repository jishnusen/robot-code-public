<!DOCTYPE hmtl>

<html>
  <head>
    <title>1678 WebDash</title>
    <script src="CollapsibleLists.js"></script>
    <link rel="stylesheet" type="text/css">
  </head>
  <body>
  </body>
  <script>
    var datasock = new WebSocket("ws://" + document.location.host + "/data");

    var videolistsock = new WebSocket("ws://" + document.location.host + "/videolist");

    var has_made_list = false;

    function MakeList(data) {
      var text = "Click on any item to show all fields:<br/><ul id=\"lists\" class=\"collapsibleList\">";
      for (var key in data) {
        text += "<li>" + key + "<ul id=" + key + ">";
        text += "</ul></li>";
      }
      text += "</ul>"
      document.body.innerHTML = text;
    }

    var video_streams = [];

    function UpdateList(data) {
      for (var key in data) {
	var keytext = "";
        for (var element in data[key]) {
          CollapsibleLists.apply();
	  CollapsibleLists.apply();
	  keytext += "<li>" + element + " = " + data[key][element] + "</li>";
	  console.log(data[key][element]);
        }
	document.getElementById(key).innerHTML = keytext;
      }
    }

    datasock.onmessage = function(data) {
      var json_data = JSON.parse(data.data);
      if (!has_made_list) {
        MakeList(json_data)
        has_made_list = true;
      } else {
        UpdateList(json_data);
      }
    };

    videolistsock.onmessage = function(data) {
      var streams = JSON.parse(data.data);
      if (streams.length == 0) {
        return;
      }
      var element = document.getElementById("lists");
      if (element == undefined) {
        setTimeout(function(){ videolistsock.onmessage(data); }, 100);
        return;
      }
      var html_string = "<li>video streams<ul id=\"streamlist\" class=\"collapsibleList\">";
      for (var stream of streams) {
        html_string += "<li><a href=\"http://" + document.location.hostname + ":5802/" + stream + "\">" + stream + "</a></li>";
      }
      html_string += "</ul></li>";
      element.innerHTML = html_string + element.innerHTML;
      CollapsibleLists.apply();
    };

    videolistsock.onopen = function(stream) {
      videolistsock.send("ping");
    }

    function ReadData() {
      datasock.send("ping");
    }

    var intervalID = setInterval(ReadData, 100);
  </script>
</html>
